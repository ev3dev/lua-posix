From: Enrico Tassi <gareuselesinge@debian.org>
Date: Sun, 30 Jun 2013 11:42:21 +0200
Subject: Fix build on hurd-i386

See http://www.debian.org/ports/hurd/
---
 lposix.c | 20 ++++++++++++++++++++
 1 file changed, 20 insertions(+)

diff --git a/lposix.c b/lposix.c
index 5f3de33..fa4c0b9 100644
--- a/lposix.c
+++ b/lposix.c
@@ -11,6 +11,9 @@
 * With contributions by Roberto Ierusalimschy.
 * With documentation from Steve Donovan 2012
 */
+#ifdef __GNU__
+#define _GNU_SOURCE
+#endif
 
 #include <config.h>
 
@@ -673,7 +676,19 @@ Current working directory for this process.
 */
 static int Pgetcwd(lua_State *L)
 {
+#ifdef __GNU__
+	char *b = get_current_dir_name();
+	if (b != NULL) {
+		lua_pushstring(L, b);
+		return 1;
+	} else {
+		// we return the same error as below
+		return pusherror(L, ".");
+	}
+#else
 	long size = pathconf(".", _PC_PATH_MAX);
+	if (size == -1)
+		return pusherror(L, "pathconf");
 	void *ud;
 	lua_Alloc lalloc = lua_getallocf(L, &ud);
 	char *b, *ret;
@@ -686,6 +701,7 @@ static int Pgetcwd(lua_State *L)
 		lua_pushstring(L, b);
 	lalloc(ud, b, (size_t)size + 1, 0);
 	return (ret == NULL) ? pusherror(L, ".") : 1;
+#endif
 }
 
 /***
@@ -3991,7 +4007,9 @@ LUALIB_API int luaopen_posix_c (lua_State *L)
 #define MENTRY(_e) set_integer_const(LPOSIX_STR_1(LPOSIX_SPLICE(_SA, _e)), LPOSIX_SPLICE(SA, _e))
 	MENTRY( _NOCLDSTOP	);
 #if _POSIX_VERSION >= 20112L
+#ifndef __GNU__
 	MENTRY( _NOCLDWAIT	);
+#endif
 	MENTRY( _RESETHAND	);
 	MENTRY( _NODEFER	);
 #endif
@@ -4133,7 +4151,9 @@ LUALIB_API int luaopen_posix_c (lua_State *L)
 	MENTRY( OCRNL		);
 	MENTRY( ONLRET		);
 	MENTRY( OFILL		);
+#ifndef __GNU__
 	MENTRY( OFDEL		);
+#endif
 	MENTRY( NLDLY		);
 	MENTRY( NL0		);
 	MENTRY( NL1		);
